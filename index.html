<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡é©—è­‰ - æ­¥é©Ÿ1</title>
    <script src="https://www.google.com/recaptcha/api.js?render=6LeYV1wsAAAAANE7pg2hb5wHJPJ_rRGahXO139z6" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 500px; margin: 50px auto; padding: 20px; line-height: 1.6;">
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #4285f4; margin: 0;">æ­¡è¿åŠ å…¥æœƒå“¡</h1>
        <p style="color: #666; margin: 10px 0 0 0;">æ­¥é©Ÿ 1/2ï¼šå–å¾—é©—è­‰ç¢¼</p>
    </div>

    <form id="emailForm">
        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">ğŸ“§ é›»å­éƒµä»¶åœ°å€</label>
            <input type="email" id="userEmail" placeholder="è«‹è¼¸å…¥æ‚¨çš„é›»å­éƒµä»¶" required 
                   style="width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        
        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 12px; font-weight: 500;">ğŸ¤– é©—è­‰æ‚¨ä¸æ˜¯æ©Ÿå™¨äºº</label>
            <div id="recaptcha-container"></div>
        </div>
        
        <button type="submit" id="getCodeBtn" 
                style="width: 100%; padding: 16px; background: linear-gradient(135deg, #4285f4, #34a853); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer;">
            ğŸš€ ç«‹å³å–å¾—é©—è­‰ç¢¼
        </button>
    </form>
    
    <div id="status" style="margin-top: 25px; padding: 15px; border-radius: 8px; text-align: center; display: none;"></div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDZK81m6lJowSHWRg3nabnWiIQQEYlKvp0",
            authDomain: "nova-studio-service-2b937.firebaseapp.com",
            projectId: "nova-studio-service-2b937",
            storageBucket: "nova-studio-service-2b937.firebasestorage.app",
            messagingSenderId: "920210282132",
            appId: "1:920210282132:web:ac69242994fcf43557c681",
            measurementId: "G-9J5BT7XDHZ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // âœ… EmailJS åˆå§‹åŒ– - æ–° Template ID
        emailjs.init("To2oJpnpive7AotSz");

        const EMAILJS_CONFIG = {
            serviceID: "service_f18cej6",
            templateID: "template_85h7rrn",  // âœ… æ–° Template IDï¼
            publicKey: "To2oJpnpive7AotSz"
        };

        const recaptchaSiteKey = '6LeYV1wsAAAAANE7pg2hb5wHJPJ_rRGahXO139z6';

        function generateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            for (let i = 0; i < 5; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
            status.style.background = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
            status.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
            status.style.border = `1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#bee5eb'}`;
        }

        // âœ… EmailJS é™¤éŒ¯åŠ å¼·ç‰ˆ
        async function sendEmail(email, requestTime, code1, code2) {
            console.log('ğŸš€ EmailJS ç™¼é€æ¸¬è©¦ï¼š');
            console.log('- Service:', EMAILJS_CONFIG.serviceID);
            console.log('- Template:', EMAILJS_CONFIG.templateID);
            console.log('- æ”¶ä»¶äººï¼š', email);
            console.log('- é©—è­‰ç¢¼ï¼š', code1, code2);
            
            try {
                const response = await emailjs.send(
                    EMAILJS_CONFIG.serviceID,
                    EMAILJS_CONFIG.templateID,
                    {
                        user: email.split('@')[0],        // åå­—éƒ¨åˆ†
                        request_time: requestTime,
                        code_1: code1,
                        code_2: code2,
                        verify_link: window.location.origin + '/verify.html'
                    },
                    EMAILJS_CONFIG.publicKey
                );
                
                console.log('âœ… EmailJS æˆåŠŸï¼ç‹€æ…‹ï¼š', response.status);
                return response;
                
            } catch (error) {
                console.error('âŒ EmailJS éŒ¯èª¤ï¼š', error.status, error.text);
                showStatus('âš ï¸ é©—è­‰ç¢¼å·²å„²å­˜ï¼Œä½†éƒµä»¶å¯èƒ½å»¶é²ï¼Œè«‹ç¨å¾Œæª¢æŸ¥æ”¶ä»¶åŒ£', 'info');
                return { status: 200 }; // ç¹¼çºŒæµç¨‹
            }
        }

        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('userEmail').value.trim();
            if (!email || !email.includes('@')) {
                showStatus('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€', 'error');
                return;
            }

            const btn = document.getElementById('getCodeBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'â³ è™•ç†ä¸­...';

            try {
                // reCAPTCHA é©—è­‰
                const recaptchaToken = await grecaptcha.execute(recaptchaSiteKey, {action: 'submit'});
                
                // ç”Ÿæˆé©—è­‰ç¢¼
                const code1 = generateCode();
                const code2 = generateCode();
                const requestTime = new Date().toLocaleString('zh-TW', { 
                    timeZone: 'Asia/Taipei',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                console.log('ğŸ”‘ é©—è­‰ç¢¼ï¼š', code1, code2);

                // å„²å­˜ Firebase
                await db.collection('verificationRequests').add({
                    email: email,
                    code1: code1,
                    code2: code2,
                    requestTime: requestTime,
                    used: false,
                    createdAt: firebase.firestore.Timestamp.now()
                });

                // ç™¼é€éƒµä»¶
                await sendEmail(email, requestTime, code1, code2);

                showStatus('âœ… é©—è­‰ç¢¼å·²ç™¼é€ï¼è«‹æª¢æŸ¥æ”¶ä»¶åŒ£ï¼ˆåƒåœ¾éƒµä»¶åŒ£ï¼‰3ç§’å¾Œè·³è½‰', 'success');
                
                setTimeout(() => {
                    window.location.href = 'verify.html?email=' + encodeURIComponent(email);
                }, 2500);
                
            } catch (error) {
                console.error('âŒ éŒ¯èª¤ï¼š', error);
                showStatus('âŒ ç³»çµ±éŒ¯èª¤ï¼Œè«‹é‡æ–°å˜—è©¦', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    </script>
</body>
</html>