<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Club æœƒå“¡å¹³å°</title>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .login-box, .dashboard, .admin-panel { background: white; border-radius: 20px; padding: 30px; margin: 20px 0; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .status { padding: 15px; border-radius: 10px; margin: 10px 0; font-weight: bold; }
        .status.æœªå…¥æˆ°éšŠ { background: #ffeaa7; color: #fdcb6e; }
        .status.æˆ°éšŠæˆå“¡ { background: #00b894; color: white; }
        input, button { padding: 12px 20px; border: none; border-radius: 10px; font-size: 16px; margin: 5px; }
        input { border: 2px solid #ddd; width: 250px; }
        button { background: #667eea; color: white; cursor: pointer; transition: all 0.3s; }
        button:hover { background: #5a67d8; transform: translateY(-2px); }
        button.danger { background: #e17055; }
        button.danger:hover { background: #d63031; }
        .member-code { font-size: 24px; font-weight: bold; color: #00cec9; background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 10px 0; }
        h1 { color: white; text-align: center; margin-bottom: 30px; }
        .hidden { display: none; }
        #adminPanel { border-top: 4px solid #fd79a8; }
        #adminResult { margin-top: 15px; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒŒ Nova Club æœƒå“¡å¹³å°</h1>
        
        <!-- ç™»å…¥å€å¡Š -->
        <div id="loginBox" class="login-box">
            <h2>æ­¡è¿åŠ å…¥ Nova Club</h2>
            <p>ä½¿ç”¨ Google å¸³è™Ÿè¨»å†Š/ç™»å…¥</p>
            <button id="googleSignInBtn" onclick="googleSignIn()" style="width: 100%; font-size: 18px;">
                ğŸ‘¤ ä½¿ç”¨ Google ç™»å…¥
            </button>
        </div>

        <!-- æœƒå“¡ä¸»ç•«é¢ -->
        <div id="dashboard" class="dashboard hidden">
            <h2>æ­¡è¿ï¼Œ<span id="userName"></span>ï¼</h2>
            <div id="memberCode" class="member-code">è¼‰å…¥ä¸­...</div>
            <div id="memberStatus" class="status">è¼‰å…¥ä¸­...</div>
            <button onclick="signOut()" style="width: 100%;">ç™»å‡º</button>
        </div>

        <!-- ç®¡ç†å“¡å¾Œå° -->
        <div id="adminPanel" class="admin-panel hidden">
            <h2>ğŸ”§ ç®¡ç†å“¡å¾Œå° <span style="color:#fd79a8;">(åƒ…é™ oliver2013.tw@gmail.com)</span></h2>
            <input type="text" id="adminCodeInput" placeholder="è¼¸å…¥æœƒå“¡ä»£è™Ÿ (å¦‚ï¼šA7B9C2D4E6)" maxlength="10">
            <br>
            <button onclick="addToTeam()">âœ… åŠ å…¥æˆ°éšŠ</button>
            <button onclick="removeFromTeam()" class="danger">âŒ ç§»é™¤æˆ°éšŠæ¬Šé™</button>
            <button onclick="removeMember()" class="danger">ğŸ—‘ï¸ ç§»é™¤æœƒå“¡</button>
            <div id="adminResult"></div>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCzd6YU9w9v8Gn6Q1-4ydy0vpHpKFtz8wU",
            authDomain: "nova-studio-service.firebaseapp.com",
            projectId: "nova-studio-service",
            storageBucket: "nova-studio-service.firebasestorage.app",
            messagingSenderId: "1081914055644",
            appId: "1:1081914055644:web:9cb37c52abfd548f678d19"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ç”Ÿæˆå”¯ä¸€æœƒå“¡ä»£è™Ÿ (10ä½è‹±æ•¸æ··åˆ)
        function generateMemberCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 10; i++) {
                code += chars.charAt(Math.random() * chars.length | 0);
            }
            return code;
        }

        // Google ç™»å…¥
        async function googleSignIn() {
            try {
                if (auth.currentUser) {
                    loadUserDashboard();
                    return;
                }

                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({
                    prompt: 'select_account'
                });

                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                await setupUserProfile(user);
            } catch (error) {
                alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
            }
        }

        // å»ºç«‹/æ›´æ–°æœƒå“¡è³‡æ–™
        async function setupUserProfile(user) {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();
            
            if (!doc.exists) {
                let memberCode = generateMemberCode();
                // ç¢ºä¿å”¯ä¸€æ€§
                let unique = false;
                while (!unique) {
                    const check = await db.collection('users').where('memberCode', '==', memberCode).get();
                    if (check.empty) unique = true;
                    else memberCode = generateMemberCode();
                }
                
                await userRef.set({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    memberCode: memberCode,
                    status: 'æœªå…¥æˆ°éšŠ',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('ğŸ‰ æ­¡è¿æ–°æœƒå“¡ï¼
ä½ çš„æœƒå“¡ä»£è™Ÿï¼š
' + memberCode + '

è«‹è¨˜ä¸‹ä¾†æˆ–æˆªåœ–ä¿å­˜ï¼

åˆ†äº«çµ¦æœ‹å‹åŠ å…¥ Nova Clubï¼');
            }
            loadUserDashboard();
        }

        // è¼‰å…¥æœƒå“¡ä¸»ç•«é¢
        async function loadUserDashboard() {
            const user = auth.currentUser;
            if (!user) return;

            document.getElementById('loginBox').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('userName').textContent = user.displayName;
            
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();
            const data = doc.data();
            
            document.getElementById('memberCode').innerHTML = 
                'æœƒå“¡ä»£è™Ÿï¼š<br><strong>' + data.memberCode + '</strong>';
            const statusEl = document.getElementById('memberStatus');
            statusEl.textContent = 'ç›®å‰ç‹€æ…‹ï¼š' + data.status;
            statusEl.className = 'status ' + data.status;

            // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
            if (user.email === 'oliver2013.tw@gmail.com') {
                document.getElementById('adminPanel').classList.remove('hidden');
            }
        }

        // ç®¡ç†å“¡åŠŸèƒ½ï¼šåŠ å…¥æˆ°éšŠ
        async function addToTeam() {
            const code = document.getElementById('adminCodeInput').value.trim().toUpperCase();
            if (!code) return alert('è«‹è¼¸å…¥æœƒå“¡ä»£è™Ÿ');
            
            const users = await db.collection('users').where('memberCode', '==', code).get();
            if (users.empty) return alert('âŒ æ‰¾ä¸åˆ°æœƒå“¡ä»£è™Ÿï¼š' + code);
            
            const userDoc = users.docs[0];
            const userData = userDoc.data();
            if (userData.status === 'æˆ°éšŠæˆå“¡') {
                return alert('æ­¤æœƒå“¡å·²åœ¨æˆ°éšŠä¸­');
            }
            
            await userDoc.ref.update({ status: 'æˆ°éšŠæˆå“¡' });
            document.getElementById('adminResult').innerHTML = 
                '<p style="color:green;font-weight:bold;">âœ… ' + userData.displayName + ' (' + code + ') å·²åŠ å…¥æˆ°éšŠï¼</p>';
            document.getElementById('adminCodeInput').value = '';
        }

        // ç®¡ç†å“¡åŠŸèƒ½ï¼šç§»é™¤æˆ°éšŠæ¬Šé™
        async function removeFromTeam() {
            const code = document.getElementById('adminCodeInput').value.trim().toUpperCase();
            if (!code) return alert('è«‹è¼¸å…¥æœƒå“¡ä»£è™Ÿ');
            
            const users = await db.collection('users').where('memberCode', '==', code).get();
            if (users.empty) return alert('âŒ æ‰¾ä¸åˆ°æœƒå“¡ä»£è™Ÿï¼š' + code);
            
            const userDoc = users.docs[0];
            const userData = userDoc.data();
            if (userData.status === 'æœªå…¥æˆ°éšŠ') {
                return alert('æ­¤æœƒå“¡ä¸åœ¨æˆ°éšŠä¸­');
            }
            
            await userDoc.ref.update({ status: 'æœªå…¥æˆ°éšŠ' });
            document.getElementById('adminResult').innerHTML = 
                '<p style="color:orange;font-weight:bold;">ğŸ”„ ' + userData.displayName + ' (' + code + ') å·²ç§»é™¤æˆ°éšŠæ¬Šé™ï¼</p>';
            document.getElementById('adminCodeInput').value = '';
        }

        // ç®¡ç†å“¡åŠŸèƒ½ï¼šç§»é™¤æœƒå“¡
        async function removeMember() {
            const code = document.getElementById('adminCodeInput').value.trim().toUpperCase();
            if (!code) return alert('è«‹è¼¸å…¥æœƒå“¡ä»£è™Ÿ');
            if (!confirm('âš ï¸ ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æœƒå“¡ä»£è™Ÿ ' + code + ' å—ï¼Ÿ
æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) return;
            
            const users = await db.collection('users').where('memberCode', '==', code).get();
            if (users.empty) return alert('âŒ æ‰¾ä¸åˆ°æœƒå“¡ä»£è™Ÿï¼š' + code);
            
            const userDoc = users.docs[0];
            const userData = userDoc.data();
            await userDoc.ref.delete();
            document.getElementById('adminResult').innerHTML = 
                '<p style="color:red;font-weight:bold;">ğŸ—‘ï¸ å·²æ°¸ä¹…åˆªé™¤æœƒå“¡ï¼š' + userData.displayName + ' (' + code + ')</p>';
            document.getElementById('adminCodeInput').value = '';
        }

        // ç™»å‡º
        function signOut() {
            auth.signOut().then(() => {
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('loginBox').classList.remove('hidden');
                document.getElementById('adminResult').innerHTML = '';
            });
        }

        // ç›£è½ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadUserDashboard();
            } else {
                document.getElementById('loginBox').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
