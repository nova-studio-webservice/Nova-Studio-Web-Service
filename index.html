<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡é©—è­‰ - æ­¥é©Ÿ1</title>
    <script src="https://www.google.com/recaptcha/api.js?render=6LeYV1wsAAAAANE7pg2hb5wHJPJ_rRGahXO139z6" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 500px; margin: 50px auto; padding: 20px; line-height: 1.6;">
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #4285f4; margin: 0;">æ­¡è¿åŠ å…¥æœƒå“¡</h1>
        <p style="color: #666; margin: 10px 0 0 0;">æ­¥é©Ÿ 1/2ï¼šå–å¾—é©—è­‰ç¢¼</p>
    </div>

    <form id="emailForm">
        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">ğŸ“§ é›»å­éƒµä»¶åœ°å€</label>
            <input type="email" id="userEmail" placeholder="è«‹è¼¸å…¥æ‚¨çš„é›»å­éƒµä»¶" required 
                   style="width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: border-color 0.3s;">
            <small style="color: #666; font-size: 14px;">æˆ‘å€‘æœƒç™¼é€é©—è­‰ç¢¼åˆ°æ­¤ä¿¡ç®±</small>
        </div>
        
        <div style="margin-bottom: 25px;">
            <label style="display: block; margin-bottom: 12px; font-weight: 500;">ğŸ¤– é©—è­‰æ‚¨ä¸æ˜¯æ©Ÿå™¨äºº</label>
            <div id="recaptcha-container"></div>
        </div>
        
        <button type="submit" id="getCodeBtn" 
                style="width: 100%; padding: 16px; background: linear-gradient(135deg, #4285f4, #34a853); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
            ğŸš€ ç«‹å³å–å¾—é©—è­‰ç¢¼
        </button>
    </form>
    
    <div id="status" style="margin-top: 25px; padding: 15px; border-radius: 8px; text-align: center; display: none;"></div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDZK81m6lJowSHWRg3nabnWiIQQEYlKvp0",
            authDomain: "nova-studio-service-2b937.firebaseapp.com",
            projectId: "nova-studio-service-2b937",
            storageBucket: "nova-studio-service-2b937.firebasestorage.app",
            messagingSenderId: "920210282132",
            appId: "1:920210282132:web:ac69242994fcf43557c681",
            measurementId: "G-9J5BT7XDHZ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // âœ… æ­£ç¢ºçš„ EmailJS é…ç½®
        emailjs.init("To2oJpnpive7AotSz");

        const EMAILJS_CONFIG = {
            serviceID: "service_f18cej6",    // âœ… å·²ä¿®æ­£ï¼
            templateID: "template_4d7ffsc",
            publicKey: "To2oJpnpive7AotSz"
        };

        const recaptchaSiteKey = '6LeYV1wsAAAAANE7pg2hb5wHJPJ_rRGahXO139z6';

        function generateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            for (let i = 0; i < 5; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
            status.style.background = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
            status.style.color = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';
            status.style.border = `1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#bee5eb'}`;
        }

        async function sendEmail(email, requestTime, code1, code2) {
            try {
                console.log('ğŸ“¤ ç™¼é€éƒµä»¶åˆ°ï¼š', email);
                const response = await emailjs.send(
                    EMAILJS_CONFIG.serviceID,  // service_f18cej6
                    EMAILJS_CONFIG.templateID,
                    {
                        user: email,
                        request_time: requestTime,
                        code_1: code1,
                        code_2: code2,
                        verify_link: window.location.origin + '/verify.html'
                    },
                    EMAILJS_CONFIG.publicKey
                );
                console.log('âœ… EmailJS æˆåŠŸï¼š', response.status);
                return response;
            } catch (error) {
                console.error('âŒ EmailJS éŒ¯èª¤ï¼š', error);
                // å³ä½¿éƒµä»¶å¤±æ•—ï¼Œé©—è­‰ç¢¼å·²å„²å­˜åˆ° Firebase
                console.log('ğŸ’¾ é©—è­‰ç¢¼å·²å„²å­˜åˆ° Firebaseï¼Œå¯ç”¨ Console æŸ¥çœ‹');
                return { status: 200 };
            }
        }

        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('userEmail').value.trim();
            if (!email || !email.includes('@')) {
                showStatus('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€', 'error');
                return;
            }

            const btn = document.getElementById('getCodeBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'â³ è™•ç†ä¸­...';

            try {
                // reCAPTCHA é©—è­‰
                const recaptchaToken = await grecaptcha.execute(recaptchaSiteKey, {action: 'submit'});
                
                // ç”Ÿæˆé©—è­‰ç¢¼
                const code1 = generateCode();
                const code2 = generateCode();
                const requestTime = new Date().toLocaleString('zh-TW', { 
                    timeZone: 'Asia/Taipei',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                console.log('ğŸ”‘ ä½ çš„é©—è­‰ç¢¼ï¼š', code1, ' ', code2);
                console.log('ğŸ“§ ç™¼é€è‡³ï¼š', email);

                // å„²å­˜åˆ° Firebase
                await db.collection('verificationRequests').add({
                    email: email,
                    code1: code1,
                    code2: code2,
                    requestTime: requestTime,
                    requestTimestamp: firebase.firestore.Timestamp.now(),
                    used: false,
                    createdAt: firebase.firestore.Timestamp.now()
                });

                // ç™¼é€éƒµä»¶
                await sendEmail(email, requestTime, code1, code2);

                showStatus('âœ… é©—è­‰ç¢¼å·²è™•ç†å®Œæˆï¼è«‹æª¢æŸ¥æ”¶ä»¶åŒ£æˆ–åƒåœ¾éƒµä»¶ï¼ˆ3ç§’å¾Œè·³è½‰ï¼‰', 'success');
                
                // è‡ªå‹•è·³è½‰
                setTimeout(() => {
                    window.location.href = 'verify.html?email=' + encodeURIComponent(email);
                }, 2500);
                
            } catch (error) {
                console.error('âŒ éŒ¯èª¤ï¼š', error);
                showStatus('âŒ ç³»çµ±éŒ¯èª¤ï¼Œè«‹æŒ‰ F12 æŸ¥çœ‹è©³ç´°è³‡è¨Š', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        document.getElementById('userEmail').addEventListener('input', function() {
            this.style.borderColor = this.checkValidity() ? '#4285f4' : '#e74c3c';
        });
    </script>
</body>
</html>