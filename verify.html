<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡é©—è­‰ - æ­¥é©Ÿ2</title>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
</head>
<body style="font-family: Arial, sans-serif; max-width: 500px; margin: 50px auto; padding: 20px;">
    <h1>è¼¸å…¥é©—è­‰ç¢¼</h1>
    <p>è«‹è¼¸å…¥æˆ‘å€‘ç™¼é€è‡³æ‚¨ä¿¡ç®±çš„å…©çµ„é©—è­‰ç¢¼ï¼š</p>
    
    <form id="verifyForm">
        <div style="margin-bottom: 20px;">
            <label>é©—è­‰ç¢¼-1ï¼š</label><br>
            <input type="text" id="code1" maxlength="5" required 
                   style="width: 100%; padding: 10px; margin-top: 5px; text-transform: uppercase;">
        </div>
        <div style="margin-bottom: 20px;">
            <label>é©—è­‰ç¢¼-2ï¼š</label><br>
            <input type="text" id="code2" maxlength="5" required 
                   style="width: 100%; padding: 10px; margin-top: 5px; text-transform: uppercase;">
        </div>
        <button type="submit" style="width: 100%; padding: 12px; background: #34a853; color: white; border: none; border-radius: 4px; font-size: 16px;">
            é©—è­‰ä¸¦æˆç‚ºæœƒå“¡
        </button>
    </form>
    
    <div id="status" style="margin-top: 20px; padding: 10px;"></div>
    <div id="memberInfo" style="display: none; margin-top: 20px; padding: 20px; background: #e8f0fe; border-radius: 8px;"></div>

    <script>
        // Firebase é…ç½® (èˆ‡ç¶²ç«™1ç›¸åŒ)
        const firebaseConfig = {
            apiKey: "AIzaSyDZK81m6lJowSHWRg3nabnWiIQQEYlKvp0",
            authDomain: "nova-studio-service-2b937.firebaseapp.com",
            projectId: "nova-studio-service-2b937",
            storageBucket: "nova-studio-service-2b937.firebasestorage.app",
            messagingSenderId: "920210282132",
            appId: "1:920210282132:web:ac69242994fcf43557c681",
            measurementId: "G-9J5BT7XDHZ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.getElementById('verifyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code1 = document.getElementById('code1').value.toUpperCase();
            const code2 = document.getElementById('code2').value.toUpperCase();
            
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.textContent = 'é©—è­‰ä¸­...';

            try {
                // æŸ¥è©¢åŒ¹é…çš„é©—è­‰ç¢¼
                const snapshot = await db.collection('verificationRequests')
                    .where('code1', '==', code1)
                    .where('code2', '==', code2)
                    .where('used', '==', false)
                    .limit(1)
                    .get();

                if (snapshot.empty) {
                    showStatus('é©—è­‰ç¢¼éŒ¯èª¤æˆ–å·²ä½¿ç”¨ï¼Œè«‹é‡æ–°è«‹æ±‚', 'error');
                    return;
                }

                const doc = snapshot.docs[0];
                // æ¨™è¨˜ç‚ºå·²ä½¿ç”¨
                await doc.ref.update({
                    used: true,
                    verifiedAt: firebase.firestore.Timestamp.now()
                });

                const data = doc.data();
                showMemberSuccess(data.email, data.requestTime.toDate());
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('é©—è­‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'é©—è­‰ä¸¦æˆç‚ºæœƒå“¡';
            }
        });

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.color = type === 'success' ? 'green' : 'red';
        }

        function showMemberSuccess(email, requestTime) {
            document.getElementById('verifyForm').style.display = 'none';
            document.getElementById('status').style.display = 'none';
            
            const memberInfo = document.getElementById('memberInfo');
            memberInfo.style.display = 'block';
            memberInfo.innerHTML = `
                <h2 style="color: #34a853;">ğŸ‰ é©—è­‰æˆåŠŸï¼</h2>
                <p><strong>æ­¡è¿æœƒå“¡ï¼š</strong>${email}</p>
                <p><strong>é©—è­‰æ™‚é–“ï¼š</strong>${new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}</p>
                <p>æ‚¨ç¾åœ¨å·²æ˜¯æ­£å¼æœƒå“¡ï¼</p>
            `;
        }
    </script>
</body>
</html>
